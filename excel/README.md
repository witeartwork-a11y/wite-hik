# Excel Manager - Wite-Hik

## Описание
Модуль для работы с Excel таблицами с возможностью загрузки, редактирования и сохранения данных.

## Установка

### Установка зависимостей
PhpSpreadsheet установлен и готов к использованию:

```bash
cd /workspaces/wite-hik
composer install --ignore-platform-reqs
```

### Текущие возможности
✅ **Создание и сохранение Excel файлов** - работает полностью
⚠️ **Чтение существующих Excel файлов** - требуется расширение PHP zip (опционально)

Без расширения zip:
- Можно создавать новые Excel файлы
- Можно сохранять введенные данные в новый файл
- Нельзя читать существующие .xlsx файлы

Для полной поддержки чтения установите расширение zip:
```bash
# Для установки позже (если понадобится)
sudo apt-get install php-zip
```

## Структура файлов

```
excel/
├── index.html              # Главная страница модуля
├── css/
│   └── excel.css          # Стили для редактора
└── js/
    ├── excelManager.js    # Основная логика управления
    ├── excelEditor.js     # Дополнительные функции редактора
    └── app.js             # Утилиты и вспомогательные функции

backend/
└── excel_handler.php      # API для работы с Excel

uploads/excel/             # Загруженные Excel файлы
data/excel/                # Метаданные и сохраненные данные
```

## Использование

### 1. Открытие модуля
Перейдите по адресу: `https://wite-hik.ru/excel/` или `http://localhost/excel/`

### 2. Загрузка файла
- Нажмите кнопку "Загрузить Excel"
- Выберите .xlsx или .xls файл
- Файл будет загружен и обработан

### 3. Настройка столбцов
- Нажмите "Добавить столбец" в левой панели
- Укажите:
  - Название столбца (например: "Имя", "Email")
  - Ячейку в Excel (например: "A", "B", "C")
  - Начальную строку (обычно 2, если первая строка - заголовки)

### 4. Заполнение данных
- Справа появятся поля для ввода
- Заполните данные в строке
- Нажмите "Добавить строку" для новой записи
- Используйте кнопку "Удалить" для удаления строки

### 5. Сохранение
- Нажмите кнопку "Сохранить" в шапке
- Файл будет обработан и автоматически загружен

## Функции

### Основные
- ✅ Загрузка Excel файлов (.xlsx, .xls)
- ✅ Настройка отображаемых столбцов
- ✅ Динамическое добавление/удаление строк
- ✅ Редактирование ячеек в реальном времени
- ✅ Сохранение изменений в Excel
- ✅ Индикатор несохраненных изменений
- ✅ Предупреждение при закрытии с несохраненными данными

### Горячие клавиши
- `Ctrl/Cmd + S` - Сохранить
- `Ctrl/Cmd + N` - Добавить строку

### Дополнительные (в excelEditor.js)
- Валидация данных (email, phone, number)
- Экспорт/импорт CSV
- Автозаполнение
- Поиск и замена
- Фильтрация строк
- Сортировка
- Дублирование строк
- Статистика по столбцам

## API Endpoints

### POST /backend/excel_handler.php?action=upload
Загрузка Excel файла
```
FormData: { file: File }
```

### GET /backend/excel_handler.php?action=getSheet
Получение данных листа
```
Params: { file: string, sheet: number }
```

### POST /backend/excel_handler.php?action=save
Сохранение данных в Excel
```json
{
  "file": "excel_12345",
  "sheet": 0,
  "columns": [
    { "id": 123, "name": "Имя", "cell": "A", "startRow": 2 }
  ],
  "data": [
    { "A": "Значение 1" }
  ]
}
```

### GET /backend/excel_handler.php?action=list
Список загруженных файлов

### GET /backend/excel_handler.php?action=delete
Удаление файла
```
Params: { id: string }
```

## Требования
- PHP 7.4+
- Web сервер (Apache/Nginx)
- PhpSpreadsheet (опционально, но рекомендуется)

## Безопасность
- Все загруженные файлы хранятся в директории `uploads/excel/`
- Метаданные в `data/excel/`
- Файлы имеют уникальные ID
- Проверка типов файлов при загрузке

## Примеры использования

### Пример 1: База клиентов
```
Столбцы:
- Имя (A)
- Email (B)
- Телефон (C)
- Комментарий (D)

Начальная строка: 2
```

### Пример 2: Учет товаров
```
Столбцы:
- Артикул (A)
- Название (B)
- Цена (C)
- Количество (D)

Начальная строка: 2
```

### Пример 3: Расписание
```
Столбцы:
- Дата (A)
- Время (B)
- Мероприятие (C)
- Участники (D)

Начальная строка: 3 (если есть подзаголовки)
```

## Возможные улучшения
- [ ] Предпросмотр данных из Excel перед настройкой
- [ ] Импорт существующих данных из листа
- [ ] Массовое редактирование
- [ ] История изменений
- [ ] Шаблоны столбцов
- [ ] Экспорт в другие форматы
- [ ] Работа с формулами
- [ ] Форматирование ячеек (цвета, шрифты)

## Поддержка
При возникновении проблем проверьте:
1. Права доступа к директориям `uploads/excel/` и `data/excel/`
2. Установлена ли библиотека PhpSpreadsheet
3. Корректность путей в `backend/excel_handler.php`
4. Логи PHP на наличие ошибок
