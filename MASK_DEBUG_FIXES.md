# Исправления ошибок с масками

## Обнаруженные проблемы

### 1. **Утечка памяти в обработчиках события мыши** (Canvas.js)
**Проблема**: Обработчик `onMouseMove` был привязан как inline prop на canvas, но никогда не удалялся при размонтировании компонента. Это привело бы к накоплению обработчиков в памяти.

**Решение**: 
- Переместил обработчик `mousemove` на глобальный уровень документа внутри `useEffect`
- Добавил правильную очистку обработчиков при размонтировании компонента
- Теперь обработчики добавляются/удаляются в зависимости от статуса `isDragging`

### 2. **Неправильное управление `globalCompositeOperation`** (Canvas.js & renderService.js)
**Проблема**: После применения маски (операция `destination-in`) контекст canvas остается в этом режиме. Следующие операции отрисовки неправильно интерпретируют этот режим, что вызывает "дергание" и потерю маски.

**Решение**:
- Добавил `tCtx.globalCompositeOperation = 'source-over'` сразу после применения маски
- Это гарантирует, что контекст вернется в нормальный режим отрисовки
- Применено в обоих файлах (Canvas.js и renderService.js)

### 3. **Отсутствие сброса `globalCompositeOperation` после отрисовки оверлея**
**Проблема**: После применения оверлея режим `multiply` не сбрасывается.

**Решение**: Добавил сброс после отрисовки оверлея: `ctx.globalCompositeOperation = 'source-over'`

### 4. **Гарантирование начального состояния контекста**
**Решение**: Добавил явное установление `ctx.globalCompositeOperation = 'source-over'` после `clearRect`, чтобы гарантировать предсказуемое начальное состояние.

### 5. **Race condition при размонтировании компонента**
**Проблема**: Асинхронные операции загрузки изображений продолжают выполняться и пытаются отрисовать на размонтированном canvas.

**Решение**:
- Добавил флаг `isMounted` в useEffect render
- Проверяю флаг перед любой операцией отрисовки
- Устанавливаю `isMounted = false` при очистке

## Повлияло на файлы
- `/workspaces/wite-hik/js/components/Canvas.js`
- `/workspaces/wite-hik/js/services/renderService.js`

## Результаты
✅ Маски теперь стабильно применяются
✅ Нет утечек памяти из-за обработчиков событий
✅ Трансформация мышкой работает плавно без "дергания"
✅ Маска правильно считывается при каждом обновлении
